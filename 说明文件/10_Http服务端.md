


# http报文结构

- HttpRequest结构用来保存
- 包含的成员有
  - HttpMethod，记录方法
  - HttpVersion，记录版本
  - 三个string,分别记录URI中的
    - 路径名，从域名后的第一个“/”开始到最后一个“/”为止
    - 文件名，从域名后的最后一个“/”开始到“？”为止
    - 查询字符串，从“？”开始到“#”为止之间的部分
  - receiveTime_，记录收到报文的时间
  - `std::map<std::string, std::string> headers_`,一个map记录首部字段
- 方法:现在支持三种方法，和HTTP/1.0一样
  - get,post,head
- 支持两种版本
  - 1.0,1.1

## 解析路径

# 解析请求首部,HttpParse

## 有限状态机，无限状态机

- 有限状态机概念
  - 表示有限个状态以及在这些状态之间的转移和动作等行为的数学模型
  - 一件事可能会经过多个不同状态的转换, 转换依赖于在不同时间发生的不同事件来触发
  - 状态机可归纳为4个要素，即现态、条件、动作、次态。“现态”和“条件”是因，“动作”和“次态”是果。详解如下
    - 现态：是指当前所处的状态。
    - 条件：又称为“事件”。当一个条件被满足，将会触发一个动作，或者执行一次状态的迁移。
    - 动作：条件满足后执行的动作。动作执行完毕后，可以迁移到新的状态，也可以仍旧保持原状态。动作不是必需的，当条件满足后，也可以不执行任何动作，直接迁移到新状态。
    - 次态：条件满足后要迁往的新状态。“次态”是相对于“现态”而言的，“次态”一旦被激活，就转变成新的“现态”了。

## 解析状态
- ExpectRequestLine, 等待请求行
- ExpectHeaders,  等待头部字段
- ExpectEmptyline,  等待空行
- ExpectBody, 等待主体
- Success, 解析完毕

# 发送响应报文，HttpResponse

## 状态码
- 实现了4种状态码
  - 200, OK,一切正常
  - 301, Moved Permanently ：永久性重定向,说明请求的资源已经不存在了，需改用新的 URL 再次访问
  - 400, Bad Request ：请求报文中存在语法错误
  - 404, Not Found:请求的资源在服务器上不存在或未找到，所以无法提供给客户端

## 响应结构组成
- 版本+空格+状态码+空格+状态码描述+回车+换行
- 头部字段，实现了两种
  - Content-type
  - Content-length
- 报文主体
- 判断是否要在发完响应报文后关闭连接

## 把响应报文写入到缓冲区
```
版本+空格+状态码+空格+状态码描述+回车+换行
头部字段名+':'+字段值+回车+换行
...
头部字段名+':'+字段值+回车+换行
回车+换行
报文主体
```

# Http服务器包装

## 服务器内容

- 有三个可选择的路径名
- /hello
  - 发送一个"hello world"字符串回去
- /favicon.ico
  - 发送一个图片
- 


## 组成
- 封装了TcpServer
- onMessage函数，数据可读时会调用，注册到TcpServer的setMessageCallback
  - 先解析请求报文
  - 解析失败，发送失败响应报文，并关闭连接
  - 解析成功，调用ReplyRequest回复响应报文
- ReplyRequest
  - 先鉴别是短连接还是长连接
  - 调用WriteResponse写响应报文
  - 调用TcpConnection.send()发送数据
  - 如果是短连接shutdown连接
- WriteResponse